<!DOCTYPE html>
<meta charset="utf-8" />
<html>
<head>
<style>
body {
	background-color: rgba(0,0,0,0);
	overflow: hidden;
}

.title {
	letter-spacing: 0;
	position: absolute;
	transition: letter-spacing 3s ease-out, top 5s, left 5s;
	font-size: 64px;
	font-family: "Slabo 27px", serif;
	text-align: center;
	font-weight: bold;
	white-space: pre;
	color: hotpink;
}

.title.wide {
	letter-spacing: 1em;
}

.title span {
	/*color: transparent;*/
	text-shadow: 0px 0px 0px white;
	opacity: 1;
	transition: text-shadow 3s 0.5s, vertical-align 3s, opacity 2s ease-out;
}

.text {
	letter-spacing: 0;
	position: absolute;
	transition: letter-spacing 3s ease-out, top 5s, left 5s;
	font-size: 32px;
	font-family: "Slabo 27px", serif;
	text-align: center;
	color: lightblue;
}

.text.wide {
	letter-spacing: 1em;
}

.text span {
	/*color: transparent;*/
	text-shadow: 0px 0px 0px white;
	opacity: 1;
	transition: text-shadow 3s 0.5s, vertical-align 3s, opacity 2s ease-out;
}

</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.1/velocity.min.js"></script>
<script language="javascript" type="text/javascript">

function getParameterCaseInsensitive(object, key) {
  return object[Object.keys(object)
    .find(k => k.toLowerCase() === key.toLowerCase())
  ];
}

// Create WebSocket connection.
const socket = new WebSocket('ws://localhost:8080');

socket.onmessage = function (event) {
	var msg = JSON.parse(event.data);
	console.log('Message from server: ', msg);

	if (msg.id === 'credits')
	{
		// close the socket
		socket.close();

		var names = [ ];

		const headers = [
			{ section: "events", key: "follows", title: "New Followers!" },
			{ section: "events", key: "cheers", title: "Cheers!" },
			{ section: "events", key: "subs", title: "New Subscribers!" },
			{ section: "events", key: "reSubs", title: "Those who Resubscribed!" },
			{ section: "events", key: "giftSubs", title: "Crazy people who gave gift subs!" },
			{ section: "events", key: "giftBombs", title: "Even crazier people who droped gift bombs!" },
			{ section: "events", key: "raided", title: "Thank you Raiders!" },
			{ section: "events", key: "rewardRedemptions", title: "Decided to waste channel points" },
			{ section: "events", key: "goalContributions", title: "Contributed to goals!" },
			{ section: "events", key: "pyramids", title: "Managed to make some pyramids!" },
			{ section: "users", key: "editors", title: "Editors" },
			{ section: "users", key: "moderators", title: "Moderators", filterExistingEntries: true },
			{ section: "users", key: "subscribers", title: "Subscribers" },
			{ section: "users", key: "vips", title: "VIPs!", filterExistingEntries: true },
			{ section: "groups", key: "<group name>", title: "<group title>" },
			{ section: "users", key: "users", title: "Viewers", filterExistingEntries: true },
			{ section: "hypeTrain", key: "conductors", title: "Crazy ass Hype Train Conductors" },
			{ section: "hypeTrain", key: "contributors", title: "Those onboard the hype trains!" },
			{ section: "top", key: "allBits", title: "All time top crazy people with bits!" },
			{ section: "top", key: "monthBits", title: "Monthly crazy people with bits, but only by a little" },
			{ section: "top", key: "weekBits", title: "Crazy people just this week with bits!" },
			{ section: "top", key: "channelRewards", title: "Folks with the most channel points to waste" }
		];

		const existingUserMap = {};
		Object.entries(headers).forEach((val) => {
			const [idx, header] = val;
			var headerSection = getParameterCaseInsensitive(msg, header.section);
			if (headerSection)
			{
				let eventData = getParameterCaseInsensitive(headerSection, header.key);
				// filter existing entries in the current section
				if (header.filterExistingEntries) eventData = eventData.filter(e => !existingUserMap[header.section] || !existingUserMap[header.section].includes(e));
				if (eventData && eventData.length > 0)
				{
					names.push({ "text": header.title, "title": true });
					Object.values(eventData).forEach((entry) => {
						names.push({ "text": entry, "title": false });
					});

					// save output users by section
					if (!existingUserMap[header.section]) existingUserMap[header.section] = [];
					existingUserMap[header.section].push(...eventData);
				}
			}
		});

		//setup
		var i= 0;

		setInterval(function() {
			var text = textToContainer(names[i]);
			animateContainer(text);
			i++;
			if(i == names.length) i = 0;
		}, 3000);
	}
}

// send the GetCredits, or TestCredits request when the socket opens to kick everything off!
socket.onopen = function (event) {
	var msg = { "request": "TestCredits", "id": "credits" };
	socket.send(JSON.stringify(msg));
};

//Useful extension
Math.randomR = function(from, to){
    return Math.floor(Math.random() * (to - from + 1) + from);
}

function textToContainer(obj) {
	var text = obj.text;
	var container = $("<p class='text wide'>");
	if (obj.title)
	{
		container = $("<p class='title wide'>");
	}

	for (var i =0; i < text.length; i++) {
		var randomShadow = Math.randomR(30,50).toString();
		var randomOffset = Math.randomR(-50,50).toString();

		$("<span>" + text[i] + "</span>").appendTo($(container))
			.css("text-shadow","0px 0px "+ randomShadow +"px white")
			.css("vertical-align",randomOffset +"px")
			.css("opacity","0");
	}
	$("body").append(container);

	container.css("top",Math.randomR(0,90)+"%");
	container.css("left",Math.randomR(0,90)+"%");

	return container;
}

function animateContainer(c) {

  //after the final animation remove object from DOM
  c.on('transitionend', function (e) {
      if($(e.target).data("first") === false) {
        $(e.target).remove();
      }
  });

  //animating in and out
  var interval = setInterval(function(){
    var textContainer = c;
    textContainer.data("first",true);
    textContainer.toggleClass("wide");
    console.log(textContainer.attr("class"));
    textContainer.find("span").each( function() {
      if(textContainer.hasClass("wide")) {
        var randomShadow = Math.randomR(25,75).toString();
        var randomOffset = Math.randomR(-50,50).toString();

        $(this).css("text-shadow","0px 0px "+ randomShadow +"px white");
        $(this).css("vertical-align",randomOffset +"px");
        $(this).css("opacity","0");
        if(textContainer.data("first")) {
          textContainer.data("first", false);
        } else {
          clearInterval(interval);
        }
      } else {
        $(this).css("text-shadow","0px 0px 0px white");
        $(this).css("vertical-align","0px");
        $(this).css("opacity","1");
      }
    });
  }, 4000);
}
</script>
</head>
<body>
<div id="screen"></div>
</body>
</html>